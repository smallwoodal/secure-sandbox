name: PR Checks

on:
  pull_request:
    branches: [main]

# No secrets available in PR checks — this is intentional.
# PR CI validates code quality only. It never touches real data or credentials.

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0  # Full history needed for secret scanning and diff

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"

      - name: Install dependencies (hash-verified)
        run: |
          python -m pip install --upgrade pip
          pip install --require-hashes -r requirements.txt

      - name: Validate CODEOWNERS is configured
        run: |
          # Fail if CODEOWNERS still has placeholder team slugs
          if grep -q '@your-org/it-security' CODEOWNERS; then
            echo "ERROR: CODEOWNERS still has placeholder team slugs (@your-org/it-security)."
            echo "Replace with real GitHub team slugs before using this repo."
            exit 1
          fi
          # Fail if CODEOWNERS is missing
          if [ ! -f CODEOWNERS ]; then
            echo "ERROR: CODEOWNERS file is missing — this is a required security control."
            exit 1
          fi

      - name: Scan for secrets (gitleaks)
        uses: gitleaks/gitleaks-action@44c470ffc35caa3b1b2510a2f2d1588a5d2537cc # v2.3.7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for .env files in PR
        run: |
          # Fail if any .env files are being added in this PR
          if git diff --name-only origin/main...HEAD | grep -qE '\.env$|\.env\.'; then
            echo "ERROR: .env file detected in PR — remove it and rotate any exposed secrets"
            exit 1
          fi

      - name: Run tests
        run: pytest tests/ -v --tb=short

      - name: Lint
        run: ruff check .
